generator client {
  provider = "prisma-client"
  output   = "../app/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Group {
  id           Int                    @id @default(autoincrement())
  name         String                 @unique @db.VarChar(50)
  employees    Employee[]
  groupHistory EmployeeGroupHistory[]

  @@map("groups")
}

model Employee {
  id              Int       @id @default(autoincrement())
  name            String    @db.VarChar(100)
  nameKana        String?   @map("name_kana") @db.VarChar(100)
  groupId         Int?      @map("group_id")
  assignmentDate  DateTime? @map("assignment_date") @db.Date
  terminationDate DateTime? @map("termination_date") @db.Date

  group            Group?                          @relation(fields: [groupId], references: [id])
  shifts           Shift[]
  functionRoles    EmployeeFunctionRole[]
  positions        EmployeePosition[]
  nameHistory      EmployeeNameHistory[]
  externalAccounts EmployeeExternalAccount[]
  groupHistory     EmployeeGroupHistory[]
  roleHistory      EmployeeFunctionRoleHistory[]
  positionHistory  EmployeePositionHistory[]

  @@map("employees")
}

model Shift {
  id          Int       @id @default(autoincrement())
  employeeId  Int?      @map("employee_id")
  shiftDate   DateTime  @map("shift_date") @db.Date
  shiftCode   String?   @map("shift_code") @db.VarChar(20)
  startTime   DateTime? @map("start_time") @db.Time(6)
  endTime     DateTime? @map("end_time") @db.Time(6)
  isHoliday   Boolean?  @default(false) @map("is_holiday")
  isPaidLeave Boolean?  @default(false) @map("is_paid_leave")
  isRemote    Boolean   @default(false) @map("is_remote")

  employee      Employee?            @relation(fields: [employeeId], references: [id])
  changeHistory ShiftChangeHistory[]

  @@unique([employeeId, shiftDate])
  @@map("shifts")
}

model FunctionRole {
  id       Int     @id @default(autoincrement())
  roleCode String  @unique @map("role_code") @db.VarChar(20)
  roleName String  @map("role_name") @db.VarChar(50)
  roleType String  @default("FUNCTION") @map("role_type") @db.VarChar(20)
  isActive Boolean? @default(true) @map("is_active")

  employeeRoles EmployeeFunctionRole[]

  @@map("function_roles")
}

model EmployeeFunctionRole {
  id             Int       @id @default(autoincrement())
  employeeId     Int?      @map("employee_id")
  functionRoleId Int?      @map("function_role_id")
  roleType       String    @default("FUNCTION") @map("role_type") @db.VarChar(20)
  isPrimary      Boolean?  @default(false) @map("is_primary")
  startDate      DateTime? @map("start_date") @db.Date
  endDate        DateTime? @map("end_date") @db.Date

  employee     Employee?     @relation(fields: [employeeId], references: [id])
  functionRole FunctionRole? @relation(fields: [functionRoleId], references: [id])

  @@map("employee_function_roles")
}

model EmployeeNameHistory {
  id         Int       @id @default(autoincrement())
  employeeId Int?      @map("employee_id")
  name       String    @db.VarChar(100)
  nameKana   String?   @map("name_kana") @db.VarChar(100)
  validFrom  DateTime  @map("valid_from") @db.Date
  validTo    DateTime? @map("valid_to") @db.Date
  isCurrent  Boolean?  @default(false) @map("is_current")
  note       String?   @db.VarChar(255)
  createdAt  DateTime? @default(now()) @map("created_at")

  employee Employee? @relation(fields: [employeeId], references: [id])

  @@map("employee_name_history")
}

model ShiftChangeHistory {
  id          Int       @id @default(autoincrement())
  shiftId     Int       @map("shift_id")
  employeeId  Int?      @map("employee_id")
  shiftDate   DateTime  @map("shift_date") @db.Date
  shiftCode   String?   @map("shift_code") @db.VarChar(20)
  startTime   DateTime? @map("start_time") @db.Time(6)
  endTime     DateTime? @map("end_time") @db.Time(6)
  isHoliday   Boolean?  @map("is_holiday")
  isPaidLeave Boolean?  @map("is_paid_leave")
  isRemote    Boolean?  @map("is_remote")
  changeType  String    @map("change_type") @db.VarChar(10)
  version     Int
  changedAt   DateTime  @default(now()) @map("changed_at")
  note        String?   @db.VarChar(255)

  shift Shift @relation(fields: [shiftId], references: [id], onDelete: Restrict)

  @@unique([shiftId, version])
  @@index([shiftId, changedAt])
  @@index([employeeId, shiftDate])
  @@map("shift_change_history")
}

model EmployeeGroupHistory {
  id             Int       @id @default(autoincrement())
  employeeId     Int       @map("employee_id")
  groupId        Int?      @map("group_id")
  assignmentDate DateTime? @map("assignment_date") @db.Date
  changeType     String    @map("change_type") @db.VarChar(10)
  version        Int
  changedAt      DateTime  @default(now()) @map("changed_at")

  employee Employee @relation(fields: [employeeId], references: [id], onDelete: Restrict)
  group    Group?   @relation(fields: [groupId], references: [id], onDelete: Restrict)

  @@unique([employeeId, version])
  @@index([employeeId, changedAt])
  @@map("employee_group_history")
}

model ExternalTool {
  id       Int     @id @default(autoincrement())
  toolCode String  @map("tool_code") @db.VarChar(50)
  toolName String  @map("tool_name") @db.VarChar(100)
  isActive Boolean? @default(true) @map("is_active")

  accounts EmployeeExternalAccount[]

  @@map("external_tools")
}

model EmployeeExternalAccount {
  id             Int     @id @default(autoincrement())
  employeeId     Int?    @map("employee_id")
  externalToolId Int?    @map("external_tool_id")
  externalName   String  @map("external_name") @db.VarChar(100)
  externalId     String? @map("external_id") @db.VarChar(100)
  isActive       Boolean? @default(true) @map("is_active")

  employee     Employee?     @relation(fields: [employeeId], references: [id])
  externalTool ExternalTool? @relation(fields: [externalToolId], references: [id])

  @@map("employee_external_accounts")
}

model EmployeeFunctionRoleHistory {
  id             Int       @id @default(autoincrement())
  employeeId     Int       @map("employee_id")
  functionRoleId Int?      @map("function_role_id")
  roleType       String?   @map("role_type") @db.VarChar(20)
  isPrimary      Boolean?  @map("is_primary")
  startDate      DateTime? @map("start_date") @db.Date
  endDate        DateTime? @map("end_date") @db.Date
  changeType     String    @map("change_type") @db.VarChar(10)
  version        Int
  changedAt      DateTime  @default(now()) @map("changed_at")

  employee Employee @relation(fields: [employeeId], references: [id], onDelete: Restrict)

  @@unique([employeeId, version])
  @@index([employeeId, changedAt])
  @@map("employee_function_role_history")
}

model Position {
  id           Int     @id @default(autoincrement())
  positionCode String  @unique @map("position_code") @db.VarChar(20)
  positionName String  @map("position_name") @db.VarChar(50)
  isActive     Boolean? @default(true) @map("is_active")
  sortOrder    Int     @default(0) @map("sort_order")

  employeePositions EmployeePosition[]

  @@map("positions")
}

model EmployeePosition {
  id         Int       @id @default(autoincrement())
  employeeId Int       @map("employee_id")
  positionId Int       @map("position_id")
  startDate  DateTime  @map("start_date") @db.Date
  endDate    DateTime? @map("end_date") @db.Date

  employee Employee @relation(fields: [employeeId], references: [id], onDelete: Restrict)
  position Position @relation(fields: [positionId], references: [id], onDelete: Restrict)

  @@map("employee_positions")
}

model EmployeePositionHistory {
  id         Int       @id @default(autoincrement())
  employeeId Int       @map("employee_id")
  positionId Int?      @map("position_id")
  startDate  DateTime? @map("start_date") @db.Date
  endDate    DateTime? @map("end_date") @db.Date
  changeType String    @map("change_type") @db.VarChar(10)
  version    Int
  changedAt  DateTime  @default(now()) @map("changed_at")

  employee Employee @relation(fields: [employeeId], references: [id], onDelete: Restrict)

  @@unique([employeeId, version])
  @@index([employeeId, changedAt])
  @@map("employee_position_history")
}
